---
# Playbook para eliminar cluster GKE
# Uso: ansible-playbook -i inventory/hosts playbooks/delete-cluster.yml
#
# Requisitos:
#   - ansible-galaxy collection install google.cloud

- name: Delete GKE Cluster
  hosts: gcp
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/gcp.yml

  tasks:
    - name: Validate GCP project ID
      ansible.builtin.fail:
        msg: "gcp_project_id must be defined in group_vars/all.yml"
      when: gcp_project_id is not defined or gcp_project_id | length == 0

    - name: Display cluster to be deleted
      ansible.builtin.debug:
        msg:
          - "⚠️  WARNING: This will DELETE the following cluster:"
          - "Project ID:    {{ gcp_project_id }}"
          - "Zone:          {{ gcp_zone }}"
          - "Cluster Name:  {{ cluster_name }}"
          - ""
          - "This action CANNOT be undone!"

    - name: Get cluster information
      google.cloud.gcp_container_cluster_info:
        location: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: application
      register: cluster_list

    - name: Check if cluster exists
      ansible.builtin.set_fact:
        cluster_exists: "{{ cluster_list.resources | selectattr('name', 'equalto', cluster_name) | list | length > 0 }}"

    - name: Cluster not found
      ansible.builtin.debug:
        msg: "Cluster '{{ cluster_name }}' does not exist in zone '{{ gcp_zone }}'"
      when: not cluster_exists

    - name: Confirm deletion
      ansible.builtin.pause:
        prompt: "Type 'DELETE' to confirm cluster deletion"
      register: confirmation
      when: cluster_exists

    - name: Abort if not confirmed
      ansible.builtin.fail:
        msg: "Deletion cancelled by user"
      when:
        - cluster_exists
        - confirmation.user_input != "DELETE"

    - name: Delete GKE cluster
      google.cloud.gcp_container_cluster:
        name: "{{ cluster_name }}"
        location: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: application
        state: absent
      when:
        - cluster_exists
        - confirmation.user_input == "DELETE"
      register: deletion_result

    - name: Cluster deleted successfully
      ansible.builtin.debug:
        msg:
          - "✓ Cluster deleted successfully"
          - ""
          - "To check for orphaned resources, use:"
          - "  gcloud compute forwarding-rules list"
          - "  gcloud compute disks list"
          - "  gcloud compute addresses list"
      when: deletion_result is changed
