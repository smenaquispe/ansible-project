---
# Playbook para actualizar cluster GKE existente
# Uso: ansible-playbook -i inventory/hosts playbooks/update-cluster.yml
#
# Requisitos:
#   - ansible-galaxy collection install google.cloud kubernetes.core

- name: Update GKE Cluster
  hosts: gcp
  gather_facts: false
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/gcp.yml

  tasks:
    - name: Validate GCP project ID
      ansible.builtin.fail:
        msg: "gcp_project_id must be defined in group_vars/all.yml"
      when: gcp_project_id is not defined or gcp_project_id | length == 0

    - name: Display update configuration
      ansible.builtin.debug:
        msg:
          - "Project ID:    {{ gcp_project_id }}"
          - "Zone:          {{ gcp_zone }}"
          - "Cluster Name:  {{ cluster_name }}"
          - "Target Nodes:  {{ num_nodes }}"
          - "Autoscaling:   {{ min_nodes }}-{{ max_nodes }} nodes"
          - "CPU Limits:    {{ resource_limits.cpu.min }}-{{ resource_limits.cpu.max }} vCPUs"
          - "Memory Limits: {{ resource_limits.memory.min }}-{{ resource_limits.memory.max }} GB"
          - "CPU Target:    {{ (cluster_autoscaler_settings.cpu_utilization_target * 100) | int }}%"
          - "Memory Target: {{ (cluster_autoscaler_settings.memory_utilization_target * 100) | int }}%"
          - "Profile:       {{ autoscaling_profile }}"

    - name: Get cluster information
      google.cloud.gcp_container_cluster_info:
        location: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: application
      register: cluster_list

    - name: Find cluster
      ansible.builtin.set_fact:
        cluster_found: "{{ cluster_list.resources | selectattr('name', 'equalto', cluster_name) | list }}"

    - name: Fail if cluster doesn't exist
      ansible.builtin.fail:
        msg: "Cluster '{{ cluster_name }}' does not exist. Use create-cluster.yml first."
      when: cluster_found | length == 0

    - name: Get current cluster configuration
      ansible.builtin.set_fact:
        current_cluster: "{{ cluster_found[0] }}"
        current_node_count: "{{ cluster_found[0].initialNodeCount }}"

    - name: Display current vs target configuration
      ansible.builtin.debug:
        msg:
          - "Current Nodes: {{ current_node_count }}"
          - "Target Nodes:  {{ num_nodes }}"
          - "Target Min:    {{ min_nodes }}"
          - "Target Max:    {{ max_nodes }}"

    - name: Update GKE cluster base configuration
      google.cloud.gcp_container_cluster:
        name: "{{ cluster_name }}"
        location: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: application
        initial_node_count: 1
        logging_service: "{{ 'logging.googleapis.com/kubernetes' if enable_cloud_logging else 'none' }}"
        monitoring_service: "{{ 'monitoring.googleapis.com/kubernetes' if enable_cloud_monitoring else 'none' }}"
        addons_config:
          http_load_balancing:
            disabled: "{{ 'HttpLoadBalancing' not in cluster_addons }}"
          horizontal_pod_autoscaling:
            disabled: "{{ 'HorizontalPodAutoscaling' not in cluster_addons }}"
        state: present
      register: cluster_update

    - name: Update node pool configuration
      google.cloud.gcp_container_node_pool:
        name: default-pool
        cluster: "{{ cluster_update }}"
        location: "{{ gcp_zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: application
        initial_node_count: "{{ num_nodes }}"
        autoscaling:
          enabled: true
          min_node_count: "{{ min_nodes }}"
          max_node_count: "{{ max_nodes }}"
        config:
          machine_type: "{{ machine_type }}"
          disk_size_gb: "{{ disk_size }}"
          disk_type: "{{ disk_type }}"
          oauth_scopes:
            - https://www.googleapis.com/auth/compute
            - https://www.googleapis.com/auth/devstorage.read_only
            - https://www.googleapis.com/auth/logging.write
            - https://www.googleapis.com/auth/monitoring
        state: present
      register: node_pool_update

    - name: Get cluster credentials
      ansible.builtin.command:
        cmd: gcloud container clusters get-credentials {{ cluster_name }} --zone={{ gcp_zone }} --project={{ gcp_project_id }}
      changed_when: true

    - name: Get cluster nodes
      kubernetes.core.k8s_info:
        kind: Node
      register: nodes_info

    - name: Display updated nodes
      ansible.builtin.debug:
        msg: "Nodes: {{ nodes_info.resources | map(attribute='metadata.name') | list | join(', ') }}"

    - name: Display update summary
      ansible.builtin.debug:
        msg:
          - "âœ“ Cluster update completed successfully!"
          - ""
          - "Updated configuration:"
          - "  Nodes:       {{ num_nodes }}"
          - "  Autoscaling: {{ min_nodes }}-{{ max_nodes }}"
          - "  CPU Limits:  {{ resource_limits.cpu.min }}-{{ resource_limits.cpu.max }} vCPUs"
          - "  Memory Limits: {{ resource_limits.memory.min }}-{{ resource_limits.memory.max }} GB"
          - "  CPU Target:  {{ (cluster_autoscaler_settings.cpu_utilization_target * 100) | int }}%"
          - "  Profile:     {{ autoscaling_profile }}"
